<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>QR Astronaut AR (Stable Combo)</title>

  <!-- 固定“稳”的版本组合（MindAR README 推荐）： -->
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html,body { margin:0; height:100%; overflow:hidden; background:#000; }
    #hud {
      position: fixed; left: 12px; top: 12px; z-index: 9;
      padding: 6px 10px; border-radius: 10px; background:#0008; color:#fff;
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
      user-select: none;
    }
  </style>

  <script>
    // 让宇航员“脚底”落到二维码平面 (y=0)，不需要手动改模型原点
    AFRAME.registerComponent('feet-on-marker', {
      schema: { yoffset: {type:'number', default: 0} },
      init: function () {
        this.el.addEventListener('model-loaded', () => {
          const obj = this.el.getObject3D('mesh');
          if (!obj) return;
          const parent = this.el.object3D;
          const savedRot = parent.rotation.clone();
          parent.rotation.set(0,0,0);
          parent.updateMatrixWorld(true);

          const box = new THREE.Box3().setFromObject(obj);
          const minY = box.min.y;

          parent.rotation.copy(savedRot);
          parent.updateMatrixWorld(true);

          this.el.object3D.position.y = this.data.yoffset - minY;
        });
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      const marker = document.getElementById('marker');
      const status = document.getElementById('status');
      marker.addEventListener('targetFound',  () => status.textContent = '✔ 识别成功：已锁定二维码');
      marker.addEventListener('targetLost',   () => status.textContent = '… 正在重新锁定二维码');
    });
  </script>
</head>

<body>
  <div id="hud"><span id="status">启动中/等待识别…</span></div>

  <!-- 关键：不要加 renderer="alpha:true"。让 mind-ar 把相机视频设为 Three 场景背景 -->
  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind;"
    color-space="sRGB"
    renderer="colorManagement: true; physicallyCorrectLights: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
  >
    <!-- 资产 -->
    <a-assets timeout="30000">
      <a-asset-item id="astronaut" src="./yuhangyuan.glb"></a-asset-item>
    </a-assets>

    <!-- 相机（由 MindAR 接管位姿） -->
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- 识别到 targets.mind 的第 0 个目标（你的二维码）后，实体可见 -->
    <a-entity id="marker" mindar-image-target="targetIndex: 0">
      <!-- 调试平面：需要时解注释，设成二维码实物尺寸（米）
      <a-plane position="0 0 0" width="0.12" height="0.12" color="#00ff00" opacity="0.2"></a-plane>
      -->
      <a-entity id="astro"
        gltf-model="#astronaut"
        feet-on-marker
        rotation="-90 0 0"
        scale="0.2 0.2 0.2"
      ></a-entity>
    </a-entity>

    <!-- 简单补光，避免模型太暗 -->
    <a-entity light="type: hemisphere; intensity: 1.0; color: #ffffff; groundColor: #666666"></a-entity>
    <a-entity light="type: directional; intensity: 0.7" position="0 1 1"></a-entity>
  </a-scene>
</body>
</html>
