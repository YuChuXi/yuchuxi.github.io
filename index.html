<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>QR Astronaut AR (Fixed)</title>

  <!-- 稳定版本组合 -->
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html,body { margin:0; height:100%; overflow:hidden; background:#000; }
    /* 让 WebGL 画布铺满并且透明，视频能从底下透出来 */
    a-scene, canvas.a-canvas {
      position: fixed !important; inset: 0 !important; width: 100vw !important; height: 100vh !important;
      z-index: 1 !important; background: transparent !important; mix-blend-mode: normal !important;
    }
    /* 铺底的视频（不镜像！） */
    .ar-video-bg {
      position: fixed; inset: 0; width: 100vw; height: 100vh;
      object-fit: cover; z-index: 0; background: #000; mix-blend-mode: normal;
      /* 如需镜像，把下一行改成 transform: scaleX(-1); */
      transform: none;
      pointer-events: none; /* 防止挡住点击/触摸 */
    }
    #hud {
      position: fixed; left: 12px; top: 12px; z-index: 9;
      padding: 6px 10px; border-radius: 10px; background:#0008; color:#fff;
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC","Microsoft YaHei", sans-serif;
      user-select: none;
    }
  </style>

  <script>
    // 让宇航员脚底落到二维码平面 (y=0) + 强制材质为不透明，避免被视频“透”出来
    AFRAME.registerComponent('feet-on-marker', {
      schema: { yoffset: {type:'number', default: 0} },
      init: function () {
        this.el.addEventListener('model-loaded', () => {
          const obj = this.el.getObject3D('mesh');
          if (!obj) return;

          // —— 材质修正：全部设为不透明 & 正常混合 & 写入深度 —— 
          obj.traverse((n) => {
            if (n.isMesh && n.material) {
              const mats = Array.isArray(n.material) ? n.material : [n.material];
              mats.forEach(m => {
                m.transparent = false;
                m.opacity = 1.0;
                m.depthWrite = true;
                m.depthTest = true;
                m.alphaTest = 0.0;
                m.blending = THREE.NormalBlending;
                m.side = THREE.FrontSide;
                m.needsUpdate = true;
              });
            }
          });

          // —— 脚底贴地 ——（计算包围盒，把 minY 对齐到 y=0）
          const parent = this.el.object3D;
          const savedRot = parent.rotation.clone();
          parent.rotation.set(0,0,0);
          parent.updateMatrixWorld(true);
          const box = new THREE.Box3().setFromObject(obj);
          const minY = box.min.y;
          parent.rotation.copy(savedRot);
          parent.updateMatrixWorld(true);
          this.el.object3D.position.y = this.data.yoffset - minY;
        });
      }
    });

    // 把 MindAR 的 <video> 铺在 WebGL 画布下方（非镜像）
    function mountVideoUnderCanvas(sceneEl) {
      const sys = sceneEl.systems['mindar-image-system'];
      const video = sys && (sys.video || sys._video) || document.querySelector('video');
      if (!video) return;

      video.setAttribute('playsinline', '');
      video.setAttribute('webkit-playsinline', '');
      video.setAttribute('muted', '');
      video.muted = true;

      video.classList.add('ar-video-bg');
      if (!video.isConnected) document.body.prepend(video);

      // 确保渲染器透明，不遮住视频
      try {
        const r = sceneEl.renderer;
        if (r) {
          r.setClearAlpha(0);
          if (r.getContextAttributes && !r.getContextAttributes().alpha) {
            sceneEl.setAttribute('renderer', 'alpha: true; colorManagement: true; physicallyCorrectLights: false; antialias: true; sortObjects: true');
          }
        }
      } catch (_) {}

      // 页面旋转/全屏后重挂样式（兼容 iOS）
      setTimeout(() => mountVideoUnderCanvas(sceneEl), 1000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const scene = document.querySelector('a-scene');
      const marker = document.getElementById('marker');
      const status = document.getElementById('status');

      scene.addEventListener('arReady', () => {
        status.textContent = '✔ 摄像头已启动，开始识别二维码…';
        mountVideoUnderCanvas(scene);
      });
      scene.addEventListener('arError', (e) => {
        status.textContent = '✖ AR 启动失败：' + (e && e.detail ? e.detail : '');
      });
      marker.addEventListener('targetFound', () => status.textContent = '✔ 识别成功：宇航员已锁定二维码');
      marker.addEventListener('targetLost',  () => status.textContent = '… 正在重新锁定二维码');
    });
  </script>
</head>

<body>
  <div id="hud"><span id="status">启动中/等待识别…</span></div>

  <!-- 同目录放：index.html / yuhangyuan.glb / targets.mind（由 qr-marker.png 编译） -->
  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; autoStart: true;"
    color-space="sRGB"
    renderer="alpha: true; colorManagement: true; physicallyCorrectLights: false; antialias: true; sortObjects: true"
    loading-screen="enabled: false"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
  >
    <a-assets timeout="30000">
      <a-asset-item id="astronaut" src="./yuhangyuan.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity id="marker" mindar-image-target="targetIndex: 0">
      <a-entity id="astro"
        gltf-model="#astronaut"
        feet-on-marker
        rotation="90 0 0"
        scale="1 1 1"
      ></a-entity>
    </a-entity>

    <!-- 简单补光 -->
    <a-entity light="type: hemisphere; intensity: 1.0; color: #ffffff; groundColor: #666666"></a-entity>
    <a-entity light="type: directional; intensity: 0.7" position="0 1 1"></a-entity>
  </a-scene>
</body>
</html>
