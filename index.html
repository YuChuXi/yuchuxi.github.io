<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>MindAR + Three | 基线稳定版（直挂锚点）</title>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
    "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
  }
}
</script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;}
  #ar{position:fixed;inset:0;overflow:hidden;}
  #ar video{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit:cover; transform:none; z-index:0; background:#000; pointer-events:none;
  }
  canvas{position:absolute; inset:0; z-index:1;}
  #hud{
    position:fixed; left:12px; top:12px; z-index:5;
    color:#fff; background:#0008; border-radius:10px; padding:6px 10px;
    font:14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
  }
  #start{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    z-index:6; padding:12px 18px; border:0; border-radius:999px; font-weight:700;
    background:#aafc; color:#111; cursor:pointer;
  }
  #start:active{ transform:translate(-50%,-50%) scale(0.98); }
</style>
</head>
<body>
  <div id="ar"></div>
  <div id="hud">等待启动…</div>
  <button id="start">进入 AR</button>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { MindARThree } from 'mindar-image-three';

const container = document.querySelector('#ar');
const hud = document.querySelector('#hud');
const btn = document.querySelector('#start');

// —— MindAR：只开轻滤波，其它走默认 ——
const mindarThree = new MindARThree({
  container,
  imageTargetSrc: './targets.mind',
  uiLoading: true, uiScanning: true, uiError: true,
  filterMinCF: 0.001,
  filterBeta: 0.01,
});
const { renderer, scene, camera } = mindarThree;
renderer.setClearColor(0x000000, 0);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

// —— 灯光 ——
scene.add(new THREE.HemisphereLight(0xffffff, 0x666666, 1.0));
const dir = new THREE.DirectionalLight(0xffffff, 0.9); dir.position.set(0,1,1); scene.add(dir);

// —— 锚点 ——
const anchor = mindarThree.addAnchor(0);

// —— 载入模型（宇航员） ——
const gltf = await new GLTFLoader().loadAsync('./yuhangyuan.glb');
const astro = gltf.scene;

// 关键：防止远处视锥裁剪；材质保持正常前面渲染，不做 polygonOffset 等骚操作
astro.traverse(n=>{
  if (n.isMesh){
    n.frustumCulled = false;
    if (n.material){
      const mats = Array.isArray(n.material) ? n.material : [n.material];
      mats.forEach(m=>{
        m.transparent = false; m.opacity = 1;
        m.depthWrite = true; m.depthTest = true;
        m.alphaTest = 0; m.blending = THREE.NormalBlending;
        m.side = THREE.FrontSide;  // 保持默认前面渲染
        m.needsUpdate = true;
      });
    }
  }
});

// 姿态：立起来 + 脚贴二维码平面
astro.rotation.set(Math.PI/2, 0, 0);
astro.scale.setScalar(0.5);
{
  const parent = new THREE.Group(); parent.add(astro);
  const saved = astro.rotation.clone();
  astro.rotation.set(0,0,0);
  parent.updateMatrixWorld(true);
  const box = new THREE.Box3().setFromObject(astro);
  astro.rotation.copy(saved);
  astro.position.y -= box.min.y;
}

// 直接挂锚点：最稳
anchor.group.add(astro);

// 显隐：用回调通知 + 每帧兜底（以防某些设备回调漏发）
astro.visible = false;
anchor.onTargetFound = ()=>{ astro.visible = true;  hud.textContent = '✔ 已锁定二维码'; };
anchor.onTargetLost  = ()=>{ astro.visible = false; hud.textContent = '… 重新锁定中'; };

// —— 启动（iOS 需手势） ——
btn.addEventListener('click', async ()=>{
  btn.style.display = 'none';
  try{
    await mindarThree.start();
    hud.textContent = '✔ 相机已开启，开始识别二维码…';

    // 不再硬改 near/far，用 MindAR 默认相机参数（避免误杀可见性）
    // camera.near/camera.far 保持默认；若仍有远处闪片，再微调，不一次性拉太极端

    // 确保 <video> 铺底
    const ensureVideo = ()=>{
      const v = container.querySelector('video');
      if (!v) return;
      v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
      v.setAttribute('muted',''); v.muted = true;
      Object.assign(v.style, {
        position:'absolute', inset:'0', width:'100%', height:'100%',
        objectFit:'cover', zIndex:'0', background:'#000', transform:'none'
      });
    };
    ensureVideo();
    new MutationObserver(ensureVideo).observe(container, {childList:true, subtree:true});

    // 渲染循环：每帧跟随锚点可见性兜底
    renderer.setAnimationLoop(()=>{
      astro.visible = anchor.group.visible; // ← 关键兜底：回调漏发也能显示/隐藏
      renderer.render(scene, camera);
    });

    window.addEventListener('resize', ()=>{
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    });

  }catch(e){
    hud.textContent = '✖ 无法开启相机：' + (e?.message || e);
    btn.style.display = 'block';
  }
});
</script>
</body>
</html>
