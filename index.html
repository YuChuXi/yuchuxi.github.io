<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>MindAR + Three | 稳定版（去调试 + 远处不丢面）</title>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
    "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
  }
}
</script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;}
  #ar{position:fixed;inset:0;overflow:hidden;}
  #ar video{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit:cover; transform:none; z-index:0; background:#000; pointer-events:none;
  }
  canvas{position:absolute; inset:0; z-index:1;}
  #hud{
    position:fixed; left:12px; top:12px; z-index:5;
    color:#fff; background:#0008; border-radius:10px; padding:6px 10px;
    font:14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
  }
  #start{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    z-index:6; padding:12px 18px; border:0; border-radius:999px; font-weight:700;
    background:#aafc; color:#111; cursor:pointer;
  }
  #start:active{ transform:translate(-50%,-50%) scale(0.98); }
</style>
</head>
<body>
  <div id="ar"></div>
  <div id="hud">等待启动…</div>
  <button id="start">进入 AR</button>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { MindARThree } from 'mindar-image-three';

const container = document.querySelector('#ar');
const hud = document.querySelector('#hud');
const btn = document.querySelector('#start');

// MindAR 初始化（开启轻度滤波，稳一点）
const mindarThree = new MindARThree({
  container,
  imageTargetSrc: './targets.mind',
  uiLoading: true, uiScanning: true, uiError: true,
  filterMinCF: 0.0001,
  filterBeta: 0.0005,
  warmupTolerance: 3,
  missTolerance: 3,
});
const { renderer, scene, camera } = mindarThree;
renderer.setClearColor(0x000000, 0);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

// 灯光
scene.add(new THREE.HemisphereLight(0xffffff, 0x666666, 1.0));
const dir = new THREE.DirectionalLight(0xffffff, 0.9); dir.position.set(0,1,1); scene.add(dir);

// 锚点
const anchor = mindarThree.addAnchor(0);

// 载入模型
const gltf = await new GLTFLoader().loadAsync('./yuhangyuan.glb');
const astro = gltf.scene;

// 材质/裁剪/抗闪烁设置（关键）
astro.traverse(n=>{
  if (n.isMesh){
    n.frustumCulled = false;           // 防止远处包围盒异常被裁掉
    if (n.material){
      const mats = Array.isArray(n.material) ? n.material : [n.material];
      mats.forEach(m=>{
        m.transparent = false; m.opacity = 1;
        m.depthWrite = true; m.depthTest = true;
        m.alphaTest = 0;
        m.blending = THREE.NormalBlending;
        m.side = THREE.DoubleSide;     // 避免远处因法线/精度导致背面被裁
        m.polygonOffset = true;        // 减少自相互遮挡/远处闪烁
        m.polygonOffsetFactor = 1;
        m.polygonOffsetUnits  = 1;
        m.needsUpdate = true;
        // 可选：改善远处贴图采样
        if (m.map){
          m.map.anisotropy = renderer.capabilities.getMaxAnisotropy?.() || 8;
          m.map.minFilter = THREE.LinearMipmapLinearFilter;
          m.map.magFilter = THREE.LinearFilter;
        }
      });
    }
  }
});

// 姿态：立起来 + 脚贴二维码平面
astro.rotation.set(Math.PI/2, 0, 0);
astro.scale.setScalar(0.5);
{
  const parent = new THREE.Group(); parent.add(astro);
  const saved = astro.rotation.clone();
  astro.rotation.set(0,0,0);
  parent.updateMatrixWorld(true);
  const box = new THREE.Box3().setFromObject(astro);
  astro.rotation.copy(saved);
  astro.position.y -= box.min.y;
}

// 直接挂锚点（最稳的显隐/回捕）
anchor.group.add(astro);

// 回调做显隐
anchor.onTargetFound = ()=>{
  astro.visible = true;
  hud.textContent = '✔ 已锁定二维码';
};
anchor.onTargetLost = ()=>{
  astro.visible = false;
  hud.textContent = '… 重新锁定中';
};

// 启动（iOS 需要手势）
btn.addEventListener('click', async ()=>{
  btn.style.display = 'none';
  try{
    await mindarThree.start();
    hud.textContent = '✔ 相机已开启，开始识别二维码…';

    // 相机裁剪面 —— 提升深度精度，避免远处面片丢失
    camera.near = 0.1;   // 不要太小（0.01 容易深度精度差）
    camera.far  = 200;   // 不要太大（5000 容易远处抖动/消面）
    camera.updateProjectionMatrix();

    // 确保 <video> 铺底
    const ensureVideo = ()=>{
      const v = container.querySelector('video');
      if (!v) return;
      v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
      v.setAttribute('muted',''); v.muted = true;
      Object.assign(v.style, {position:'absolute', inset:'0', width:'100%', height:'100%', objectFit:'cover', zIndex:'0', background:'#000', transform:'none'});
    };
    ensureVideo();
    new MutationObserver(ensureVideo).observe(container, {childList:true, subtree:true});

    // 渲染循环
    renderer.setAnimationLoop(()=>{ renderer.render(scene, camera); });

    // 自适应分辨率
    window.addEventListener('resize', ()=>{
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    });

  }catch(e){
    hud.textContent = '✖ 无法开启相机：' + (e?.message || e);
    btn.style.display = 'block';
  }
});
</script>
</body>
</html>
