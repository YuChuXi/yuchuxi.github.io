<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>MindAR + Three | Astronaut on QR</title>

<!-- three + mindar（ESM + importmap） -->
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
    "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
  }
}
</script>

<style>
  html,body { margin:0; height:100%; overflow:hidden; background:#000; }
  #ar { position: fixed; inset: 0; overflow: hidden; }
  /* 我们将不再用 DOM 视频合成，后面会把它隐藏（但仍播放供追踪） */
  #ar video { display: none; } /* ★ 关键：隐藏 DOM 视频，防止和 WebGL 叠加导致“半透” */
  canvas { position:absolute; inset:0; z-index:1; }
  #hud { position:fixed; left:12px; top:12px; z-index:5; color:#fff; background:#0008; border-radius:10px; padding:6px 10px; font:14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif; }
  #start { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:6; padding:12px 18px; border:0; border-radius:999px; font-weight:700; background:#aafc; color:#111; cursor:pointer; }
  #start:active { transform:translate(-50%,-50%) scale(0.98); }
</style>
</head>
<body>
  <div id="ar"></div>
  <div id="hud">等待启动…</div>
  <button id="start">进入 AR</button>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { MindARThree } from 'mindar-image-three';

    const container = document.querySelector('#ar');
    const hud = document.querySelector('#hud');
    const btn = document.querySelector('#start');

    const mindarThree = new MindARThree({
      container,
      imageTargetSrc: './targets.mind',
      uiLoading: true, uiScanning: true, uiError: true
    });
    const { renderer, scene, camera } = mindarThree;

    // ★ 关键：画布不透明清屏，由 WebGL 自己把视频画成“背景”，不再 DOM 叠加
    renderer.setClearColor(0x000000, 1);      // alpha=1：画布不透明
    // renderer.outputColorSpace 默认就是 sRGB（r160）

    // 灯光
    scene.add(new THREE.HemisphereLight(0xffffff, 0x666666, 1.0));
    const dir = new THREE.DirectionalLight(0xffffff, 0.9); dir.position.set(0,1,1); scene.add(dir);

    // 第 0 个图像目标的锚点
    const anchor = mindarThree.addAnchor(0);

    // 平滑锚点
    const smooth = new THREE.Group(); smooth.visible = false; scene.add(smooth);

    // 模型
    const gltf = await new GLTFLoader().loadAsync('./yuhangyuan.glb');
    const astro = gltf.scene;

    // 强制材质不透明，避免任何混合
    astro.traverse(n=>{
      if(n.isMesh && n.material){
        const mats = Array.isArray(n.material)? n.material : [n.material];
        mats.forEach(m=>{
          m.transparent = false; m.opacity = 1;
          m.depthWrite = true; m.depthTest = true; m.alphaTest = 0;
          m.blending = THREE.NormalBlending; m.side = THREE.FrontSide; m.needsUpdate = true;
          // 保险：去掉可能携带的 alpha 贴图
          if (m.alphaMap) m.alphaMap = null;   // ★ 如 GLB 自带 alphaMap，会导致“透”
        });
      }
    });

    // 直立 + 缩放
    astro.rotation.set(Math.PI/2, 0, 0);
    astro.scale.setScalar(0.5);

    // 脚底贴 y=0
    {
      const parent = new THREE.Group(); parent.add(astro);
      const saved = astro.rotation.clone();
      astro.rotation.set(0,0,0);
      parent.updateMatrixWorld(true);
      const box = new THREE.Box3().setFromObject(astro);
      const minY = box.min.y;
      astro.rotation.copy(saved);
      astro.position.y -= minY;
    }
    smooth.add(astro);

    // 平滑参数
    const lerp = 0.5, slerp = 0.5;
    const tmpP = new THREE.Vector3(), tmpQ = new THREE.Quaternion(), tmpS = new THREE.Vector3(), tmpM = new THREE.Matrix4();

    anchor.onTargetFound = ()=>{ hud.textContent = '✔ 已锁定二维码（平滑中）'; smooth.visible = true; };
    anchor.onTargetLost  = ()=>{ hud.textContent = '… 重新锁定中';           smooth.visible = false; };

    btn.addEventListener('click', async ()=>{
      btn.style.display = 'none';
      try{
        await mindarThree.start();                   // 打开相机
        hud.textContent = '✔ 相机已开启，开始识别二维码…';

        // ★ 关键：把 MindAR 的 <video> 做成 WebGL 背景纹理（完全规避 DOM 叠加导致的半透）
        const v = container.querySelector('video');  // MindAR 注入的相机视频
        if (v) {
          v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
          v.setAttribute('muted',''); v.muted = true;

          const tex = new THREE.VideoTexture(v);
          tex.colorSpace = THREE.SRGBColorSpace;
          tex.minFilter = THREE.LinearFilter;
          tex.magFilter = THREE.LinearFilter;
          tex.generateMipmaps = false;

          scene.background = tex;                    // ★ 用视频纹理当场景背景
        }

        // 渲染循环
        renderer.setAnimationLoop(()=>{
          // 原始锚点世界位姿 → 平滑
          anchor.group.updateMatrixWorld();
          tmpM.copy(anchor.group.matrixWorld).decompose(tmpP, tmpQ, tmpS);
          if (smooth.visible){
            smooth.position.lerp(tmpP, lerp);
            smooth.quaternion.slerp(tmpQ, slerp);
            smooth.scale.lerp(tmpS, lerp);
          }
          renderer.render(scene, camera);
        });
      }catch(e){
        hud.textContent = '✖ 无法开启相机：' + (e?.message || e);
        btn.style.display = 'block';
      }
    });
  </script>
</body>
</html>
